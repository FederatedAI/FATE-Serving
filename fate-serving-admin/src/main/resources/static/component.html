<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<title>fate-serving-admin</title>
		<link href="css/bootstrap.css" rel="stylesheet"/>
		<link rel="stylesheet" href="css/local.css"/>
		<link href="css/bootstrap-table.min.css" rel="stylesheet"/>
	</head>

	<body>
		<header id="header" class="navbar navbar-default  navbar-static-top">
			<div class="container-fluid">
				<div class="navbar-header">
					<a class="navbar-brand" data-i18n="title" href="#" id="logo">fate-serving-admin</a>
					<a class="navbar-brand" class="btn btn-default" onclick="divhide()">
						<span class="glyphicon glyphicon-align-justify"></span>
					</a>
				</div>
			</div>
		</header>


		<div class="container-fluid">
			<div class="row">
				<div class="col-md-2" id="hiddendiv">
					<ul id="main-nav" class="nav nav-tabs nav-stacked" style="">
						<li>
							<a href="index.html">
								<i class="glyphicon glyphicon-credit-card"></i> cluster
							</a>
						</li>
						<li>
							<a href="services.html">
								<i class="glyphicon glyphicon-globe"></i> services
							</a>
						</li>
						<!--<li class="active">
							<a href="models.html">
								<i class="glyphicon glyphicon-calendar"></i> models
							</a>
						</li>-->
					</ul>

				</div>
				<div class="col-md-9">
					<h1 class="page-header" id="label">Dashboard</h1>

					<ul class="nav nav-tabs">
						<li role="presentation" class="active"><a data-toggle="tab" href="#basic">Basic</a></li>
						<li role="presentation" id="modelsTab" class="hidden"><a data-toggle="tab" href="#models">Models</a></li>
						<li role="presentation"><a data-toggle="tab" href="#jvm">JVM</a></li>
					</ul>

					<div class="panel-body">
						<div class="tab-content">
							<div id="basic" class="tab-pane active">
								<div id="basicToolbar">
									<div class="input-group col-lg-5">
										<input type="text" class="form-control" id="keyword" placeholder="Keyword">
										<span class="input-group-btn">
											<button class="btn btn-success" id="searchByKeyword" type="button">search</button>
										</span>
									</div>
								</div>
								<table id="basicTable" class="table table-no-bordered table-hover"
										data-toggle="table" 
										data-toolbar="#basicToolbar"
										data-url="api/component/listProps"
										data-query-params="basicQueryParams"
										data-response-handler="responseHandler"
										data-side-pagination="server"
										data-page-number="1"
										data-page-size="15"
										data-pagination="true"
										data-page-list="[All]">
									<thead>
										<tr>
											<th data-field="key" data-title="Key" data-sortable="true"></th>
											<th data-field="value" data-title="Value" data-sortable="true"></th>
										</tr>
									</thead>
								</table>
							</div>
							<div id="models" class="tab-pane">
								<div id="modelsToolbar">
									<div class="input-group col-lg-5">
										<input type="text" class="form-control" id="serviceId" placeholder="Service ID">
										<span class="input-group-btn">
											<button class="btn btn-success" id="searchByServiceId" type="button">search</button>
										</span>
									</div>
								</div>
								<table id="modelsTable" class="table table-no-bordered table-hover"
										data-toggle="table" 
										data-toolbar="#modelsToolbar"
										data-ajax="ajaxHandler",
										data-url="api/model/query"
										data-query-params="queryParams"
										data-response-handler="responseHandler"
										data-side-pagination="server"
										data-page-number="1"
										data-page-size="15"
										data-pagination="true"
										data-page-list="[10, 20, 30, ALL]">
									<thead>
										<tr>
											<th data-field="tableName" data-title="Table Name" data-sortable="true"></th>
											<th data-field="namespace" data-title="Namespace" data-sortable="true"></th>
											<th data-field="serviceId" data-title="Service ID" data-sortable="true"></th>
											<th data-field="role" data-title="Role" data-sortable="true"></th>
											<th data-field="partId" data-title="Part ID" data-sortable="true"></th>
											<th data-field="timestamp" data-title="Timestamp" data-sortable="true"></th>
											<th data-title="Operation" data-formatter="operationFormatter"></th>
										</tr>
									</thead>
								</table>
							</div>
							<div id="jvm" class="tab-pane">
								jvm
							</div>
						</div>
					</div>

				</div>
			</div>
		</div>
	</body>

	<script src="js/jquery-1.11.3.min.js"></script>
	<script src="js/bootstrap.js"></script>
	<link type="text/css" href="css/jquery-ui-1.9.2.custom.css" rel="stylesheet"/>
	<script type="text/javascript" src="js/jquery-ui-1.9.2.custom.min.js"></script>
	<script type="text/javascript" src="js/echarts.min.js"></script>
	<script type="text/javascript" src="js/bootbox.all.min.js"></script>
	<script type="text/javascript" src="js/bootstrap-table.min.js"></script>

	<script>
		var _config = init();
		
		$(function() {
			$('#searchByServiceId').click(function() {
				$('#modelsTable').bootstrapTable('refresh', {silent: true});
			})

			$('#searchByKeyword').click(function() {
				$('#basicTable').bootstrapTable('refresh', {silent: true});
			})
		});

		function init() {
			var _params = {}
			var query = window.location.search.substring(1);
			var vars = query.split("&");
			for (var i in vars) {
				var pair = vars[i].split("=");
				_params[pair[0]] = pair[1]
			}
			
			if (_params.label) {
				$('#label').text(_params.label);
				var _labels = _params.label.split('-');
				if (_labels[1] == 'serving') {
					$('#modelsTab').removeClass('hidden');
					$('#modelsTab').addClass('show');
					_params.showModels = true;
				}
			}

			var _target = _params.target.split(':');
			_params.host = _target[0];
			_params.port = parseInt(_target[1]);
			return _params;
		}

		function ajaxHandler(params) {
			if (_config.showModels) {
				$.ajax(params);
			} else {
				params.success({
					retcode: "0",
					data: {
						total: 0,
						rows: []
					}
				});
			}
		}

		function basicQueryParams(params){
			params.host = _config.host;
			params.port = _config.port;
			params.keyword = $('#keyword').val();
			return params;
		}

		function queryParams(params){
			params.host = _config.host;
			params.port = _config.port;
			params.serviceId = $('#serviceId').val();
			params.page = 1 + (params.offset / params.limit);
			params.pageSize = params.limit;
			return params;
		}

		function responseHandler(res) {
			var result = {
				rows: [],
				total: 0
			}
			if (res) {
				result = res.data;
			}
			return result;
		}

		function operationFormatter(value, row, index) {
			return '<div class="btn-group"><button type="button" class="btn btn-success btn-sm" onclick="doUnload(' + JSON.stringify(row).replace(/"/g, '&quot;') + ')">Unload</button>'
			 + '<button type="button" class="btn btn-success btn-sm" onclick="doUnbind(' + JSON.stringify(row).replace(/"/g, '&quot;') + ')">Unbind</button></div>';
		}

		function doUnload(row) {
			bootbox.confirm({
				title: "Confirm",
				message: 'Unload model ' + row.tableName + '_' + row.namespace + '?',
				callback: function (confirm) {
					if (confirm) {
						$.post("api/model/unload", {
							host: _config.host,
							port: _config.port,
							tableName: row.tableName,
							namespace: row.namespace
						}, function(result){
							bootbox.hideAll();
							if (result.retmsg) {
								bootbox.alert(result.retmsg);
								return;
							}
							bootbox.dialog({
								message: '<p class="text-center">unload success</p>',
								size: 'small',
								closeButton: false
							});
							$('#modelsTable').bootstrapTable('refresh', {silent: true});
							setTimeout(function(){
								bootbox.hideAll();
							}, 500);
						});
					}
				}
			});
		}
		
		function doUnbind(row) {
			bootbox.confirm({
				title: "Confirm",
				message: 'Unbind model ' + row.serviceId + '?',
				callback: function (confirm) {
					if (confirm) {
						$.post("api/model/unbind", {
							host: _config.host,
							port: _config.port,
							tableName: row.tableName,
							namespace: row.namespace,
							serviceId: row.serviceId
						}, function(result){
							bootbox.hideAll();
							if (result.retmsg) {
								bootbox.alert(result.retmsg);
								return;
							}
							bootbox.dialog({
								message: '<p class="text-center">unbind success</p>',
								size: 'small',
								closeButton: false
							});
							$('#modelsTable').bootstrapTable('refresh', {silent: true});
							setTimeout(function(){
								bootbox.hideAll();
							}, 500);
						});
					}
				}
			});
		}

	</script>


</html>